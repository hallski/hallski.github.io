<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="/favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta http-equiv="content-security-policy" content=""><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed"><link rel="stylesheet" href="/css/style.css" type="text/css">
	<link rel="stylesheet" href="/_app/assets/pages/__layout.svelte-3ab4768d.css">
	</head>
	<body>
		<div id="svelte">




<header><nav class="navbar svelte-d1vz7p"><a class="nav-link svelte-d1vz7p" href="/">Home</a>
		<ul class="svelte-d1vz7p">
			<li class="svelte-d1vz7p"><a href="/blog/" class="nav-link svelte-d1vz7p">Articles</a></li>
			
			<li class="svelte-d1vz7p"><a href="/about" class="nav-link svelte-d1vz7p">About</a></li></ul></nav>
</header>

<main class="main"><div class="content"><article class="post"><header><h1>Building integrations with Google Cloud Functions</h1>
		<span class="post-date">November 03, 2017</span></header>
	<h2>Google Cloud Functions (GCF)</h2>
<p>GCF is Googles version of AWS Lambda which provides a <em>“server less”</em> (in the sense that as a developer you don’t need to care about anything other than your code) service to run code in the cloud. This type of service is often called Function as a Service, or FaaS for short.</p>
<p>It’s a perfect solution for event triggered small integrations or transformations. Such as a webhook for callbacks from various services. As a developer you only have to implement the event handler and can ignore any OS or HTTP Server setup or administration. The cloud provider takes care of all of that as well as scaling if load increases.</p>
<p>This of course comes with some constraints and in the case of Google Cloud Functions it means a function can be triggered by <em>HTTPS requests</em>, <em>Cloud Storage Events</em> or <em>Pub/Sub</em> and is (currently) limited
to Node.js v6.11.1.</p>
<h2>The Catfinder function</h2>
<p>As an example of setting up an integration as a function this post will use a small function that integrates Google Cloud Storage, Google Vision and Slack. It works by getting a change event from a Cloud Storage bucket and send any new files to the Vision API to decide whether it’s an image of a cat. If it is, it will send a message to Slack notifying that a new cat picture was uploaded.</p>
<p>All the code for the project can be found at <a href="https://github.com/hallski/cat-finder" rel="nofollow">Github</a>.</p>
<h3>Implementation</h3>
<p>A cloud function is a normal NPM module where the script pointed to by <code>main</code> in <code>package.json</code> needs to export a function with the same name as the function (by default, this can be overridden with the <code>--entry-point</code> flag when deploying).</p>
<p>In our <code>package.json</code> the main module is defined to be <code>src/index.js</code> and the exported function is called <code>catFinder</code>. The function has different signatures depending on the trigger mechanism. In the case of a bucket event it will have the signature:</p>
<div class="highlighter-rouge language-javascript"><div class="highlight"><pre class="highlight"><code><span class="hljs-built_in">exports</span>.<span class="hljs-property">catFinder</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event, callback</span>) {}</code></pre></div></div>
<p>The <code>event</code> contains information about the event, such as file name, bucket name, event type etc. The <code>callback</code> is used to notify that the function has finished.</p>
<p>The first thing we need to do is check that we care about the event, for this project only newly created files are interesting. In order to keep this logic out of the actual function implementation I’ve written a small helper that wraps the function and returns if the event doesn’t match the criteria.</p>
<div class="highlighter-rouge language-javascript"><div class="highlight"><pre class="highlight"><code><span class="hljs-comment">// From src/google-cloud.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">filteredEventHandler</span>(<span class="hljs-params">predicate, handler</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">predicate</span>(event)) {
      <span class="hljs-title function_">handler</span>(event, callback)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">callback</span>()
    }
  }
}

<span class="hljs-comment">// In index.js</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">catFinder</span> = <span class="hljs-title function_">filteredEventHandler</span>(storageNewFileEventFilter, <span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) {
  <span class="hljs-comment">// ...</span>
}</code></pre></div></div>
<p>The <code>storageNewFileEventFilter</code> function takes in the event and checks whether it’s referring to a new file event. It checks that the resource still exists (otherwise it’s a delete event) and that the <code>metageneration</code> is <code>1</code>, otherwise it’s an update event.</p>
<div class="highlighter-rouge language-javascript"><div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">storageNewFileEventFilter</span>(<span class="hljs-params">event</span>) {
	<span class="hljs-keyword">const</span> file = event.<span class="hljs-property">data</span>
	<span class="hljs-keyword">return</span> file.<span class="hljs-property">resourceState</span> === <span class="hljs-string">&#39;exists&#39;</span> &amp;&amp; file.<span class="hljs-property">metageneration</span> === <span class="hljs-string">&#39;1&#39;</span>
}</code></pre></div></div>
<p>With the help of <em>Promises</em> the rest of the event handler function is very straight forward.</p>
<div class="highlighter-rouge language-javascript"><div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">const</span> file = event.<span class="hljs-property">data</span>
<span class="hljs-keyword">const</span> storageUri = <span class="hljs-string">`gs://<span class="hljs-subst">${file.bucket}</span>/<span class="hljs-subst">${file.name}</span>`</span>

<span class="hljs-keyword">return</span> <span class="hljs-title function_">visionFetchLabels</span>(storageUri)
	.<span class="hljs-title function_">then</span>(<span class="hljs-title function_">any</span>(isCat))
	.<span class="hljs-title function_">then</span>(<span class="hljs-title function_">notifySlack</span>(secrets.<span class="hljs-property">slackWebhook</span>, <span class="hljs-string">`A cat was posted: <span class="hljs-subst">${storageUri}</span>`</span>))
	.<span class="hljs-title function_">then</span>(logSuccess, logError)
	.<span class="hljs-title function_">then</span>(callback)</code></pre></div></div>
<ol><li>Fetch the labels through Vision API</li>
<li>If any of the labels match a cat</li>
<li>Send a notification to the Slack through an incoming webhook</li>
<li>If all succeeded, log that. Otherwise log if there was an error.</li>
<li>Finally, call the provided callback.</li></ol>
<p>We’ll focus on the <code>visionFetchLabels</code>, <code>isCat</code> and <code>notifySlack</code> functions in this post and talk more about using promises like this in a separate post.</p>
<p>Using the <em>Vision</em> API to fetch labels from an image in Cloud Storage is as easy as:</p>
<div class="highlighter-rouge language-javascript"><div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">visionFetchLabels</span>(<span class="hljs-params">uri</span>) {
	<span class="hljs-keyword">const</span> visionRequest = { <span class="hljs-attr">source</span>: { <span class="hljs-attr">imageUri</span>: uri } }

	<span class="hljs-keyword">return</span> vision.<span class="hljs-title function_">labelDetection</span>(visionRequest).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">results</span>) {
		<span class="hljs-keyword">return</span> results[<span class="hljs-number">0</span>].<span class="hljs-property">labelAnnotations</span>
	})
}</code></pre></div></div>
<p>The function returns a promise that fulfills to an array of label objects. The label objects contains a description and a score of how likely it is that the description matches the image. This information is used in <code>isCat</code> to determine if the image actually portraits a cat.</p>
<div class="highlighter-rouge language-javascript"><div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">isCat</span>(<span class="hljs-params">label</span>) {
	<span class="hljs-keyword">return</span> label.<span class="hljs-property">description</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#39;cat&#39;</span>) !== -<span class="hljs-number">1</span> &amp;&amp; label.<span class="hljs-property">score</span> &gt; <span class="hljs-number">0.8</span>
}</code></pre></div></div>
<p>This is a pretty naive implementation which simply checks if any of the label descriptions contain the word cat and whether the score is above <code>0.8</code> (from 0-1.0).</p>
<p>Finally, if the image is determined to match a cat, it’s posted to Slack through a webhook, which is also very straight forward:</p>
<div class="highlighter-rouge language-javascript"><div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">notifySlack</span>(<span class="hljs-params">webhook, message</span>) {
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
		<span class="hljs-keyword">return</span> request.<span class="hljs-title function_">post</span>(webhook).<span class="hljs-title function_">send</span>({ <span class="hljs-attr">text</span>: message })
	}
}</code></pre></div></div>
<p>The webhook is provided by Slack through creating a new App and adding an Incoming Webhook.</p>
<h3>Deploying the function</h3>
<p>The function is deployed to the cloud through the following command:</p>
<div class="highlighter-rouge language-bash"><div class="highlight"><pre class="highlight"><code>$ gcloud beta <span class="hljs-built_in">functions</span> deploy --memory 128 catFinder --stage-bucket function-deploy-stage --trigger-bucket=catfinder-image-bucket</code></pre></div></div>
<p>The trigger type is specified to be a bucket (meaning in storage event) and the bucket ID is <code>image-bucket-1</code>. When deploying a function this way the current directory is zipped up and pushed to the <code>stage-bucket</code> which is then used to deploy the function in the cloud.</p>
<p>In the source root directory there is a small script called <code>deploy.sh</code> that creates a DEPLOY directory and copies the correct files to it and runs the above command.</p>
<h2>Summary</h2>
<p>Cloud functions can be a great way to quickly setup some data transformation as a reaction on new files being uploaded. Or it can act as the backend for a callback from for example Slack, Github etc.</p>
<p>As demonstrated the deployment didn’t require any setup other than creating a Slack app to retrieve an incoming webhook and writing the event handler that is triggered by changes to a Storage bucket. If a lot of events are coming from the bucket, the Cloud Function service will automatically make sure that more handlers are executed to handle the incoming load.</p>
<p>Hopefully this post showed some of the power of using FaaS solutions to react to events and create an integration between different services.</p></article></div></main>

<footer class="site-footer svelte-1h9y0mo"><div class="author svelte-1h9y0mo"><img class="author-photo svelte-1h9y0mo" src="/images/hallski.jpg" width="192" height="192" alt="Author">
		<div><p class="author-name svelte-1h9y0mo">Mikael Hallendal</p>
			<p class="author-info svelte-1h9y0mo">Developer who loves to learn new things.</p>
			<p class="author-interests svelte-1h9y0mo">Current focus: <span class="interest svelte-1h9y0mo">React</span>,
				<span class="interest svelte-1h9y0mo">Javascript/Typescript</span> and
				<span class="interest svelte-1h9y0mo">Elixir</span></p>
			<nav class="find-me svelte-1h9y0mo"><a href="http://github.com/hallski/" class="svelte-1h9y0mo">Github</a>
				<a href="http://twitter.com/mhallendal/" class="svelte-1h9y0mo">Twitter</a>
				<a href="http://www.linkedin.com/in/mhallendal" class="svelte-1h9y0mo">LinkedIn</a></nav></div></div>
</footer>

</div>
	</body>
</html>
