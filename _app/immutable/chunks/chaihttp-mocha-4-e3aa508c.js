import{S as Ns,i as Ss,s as bs,k as r,q as e,a as g,l as n,m as o,r as s,h as a,c as P,n as c,b as d,D as t,B as De}from"./index-57d6417f.js";function Ts(ys){let v,j,Pt,jt,ot,wt,At,ht,w,S,b,i,T,yt,Nt,x,St,bt,q,Tt,xt,H,qt,Ht,k,kt,It,I,Ct,Dt,C,Mt,Vt,D,Ot,Bt,M,Rt,Ut,V,Wt,Zt,O,zt,Ft,B,Gt,Jt,R,Kt,Lt,U,Qt,Xt,W,Yt,$t,Z,te,ee,z,se,ae,F,le,re,G,ne,oe,J,ie,he,ct,_,ce,A,pe,ue,pt,K,de,ut,L,fe,dt,Q,ve,ft,m,_e,it,me,Ee,vt,y,X,Y,u,ge,$,Pe,tt,je,we,et,Ae,ye,st,Ne,at,Se,be,lt,Te,xe,rt,qe,nt,He,_t,E,ke,N,Ie,Ce;return{c(){v=r("p"),j=r("a"),Pt=e("Chai-http"),jt=e(" makes it very easy to test Node.js HTTP applications without having to to go through the hassle of finding a free port and start the service manually. By simply passing the server function to the "),ot=r("code"),wt=e("request"),At=e(" call it will take care of that for you."),ht=g(),w=r("div"),S=r("div"),b=r("pre"),i=r("code"),T=r("span"),yt=e("const"),Nt=e(" chai = "),x=r("span"),St=e("require"),bt=e("("),q=r("span"),Tt=e("'chai'"),xt=e(`)
`),H=r("span"),qt=e("const"),Ht=e(" chaiHttp = "),k=r("span"),kt=e("require"),It=e("("),I=r("span"),Ct=e("'chai-http'"),Dt=e(`)
`),C=r("span"),Mt=e("const"),Vt=e(" express = "),D=r("span"),Ot=e("require"),Bt=e("("),M=r("span"),Rt=e("'express'"),Ut=e(`)

chai.`),V=r("span"),Wt=e("use"),Zt=e(`(chaiHttp)

`),O=r("span"),zt=e("const"),Ft=e(" app = "),B=r("span"),Gt=e("express"),Jt=e(`()
`),R=r("span"),Kt=e("// configure app with middleware and routes..."),Lt=e(`

chai
	.`),U=r("span"),Qt=e("request"),Xt=e(`(app)
	.`),W=r("span"),Yt=e("get"),$t=e("("),Z=r("span"),te=e("'/'"),ee=e(`)
	.`),z=r("span"),se=e("end"),ae=e("("),F=r("span"),le=e("function"),re=e(" ("),G=r("span"),ne=e("error, result"),oe=e(`) {
		`),J=r("span"),ie=e("// Verify error and result"),he=e(`
	})`),ct=g(),_=r("p"),ce=e("At first I thought it simulated HTTP requests by generating the request/response objects and passing them to the handler function directly. However it seems Chai-http actually finds a free port, starts the service as normal and uses "),A=r("a"),pe=e("Superagent"),ue=e(" to send HTTP requests against it."),pt=g(),K=r("p"),de=e("This lead to an issue when switching to Mocha 4."),ut=g(),L=r("h2"),fe=e("Mocha 4 changed exit behaviour"),dt=g(),Q=r("p"),ve=e("As I started a new project the other day I ran into a problem where the test runner never finishes and initially thought I had messed up my tests. After some investigation it seemed like Node.js never exits the event loop due to the HTTP server still listening to the socket."),ft=g(),m=r("p"),_e=e("It turns out that Mocha 4 changed the default exit behaviour to no longer force shutdown the event loop after all tests ran. Using the "),it=r("code"),me=e("--exit"),Ee=e(" flags brings back the old behaviour which Chai-http is relying on to shutdown the HTTP server it started."),vt=g(),y=r("div"),X=r("div"),Y=r("pre"),u=r("code"),ge=e("  "),$=r("span"),Pe=e('"scripts"'),tt=r("span"),je=e(":"),we=e(" "),et=r("span"),Ae=e("{"),ye=e(`
    `),st=r("span"),Ne=e('"test"'),at=r("span"),Se=e(":"),be=e(" "),lt=r("span"),Te=e('"mocha --exit"'),xe=e(`
  `),rt=r("span"),qe=e("}"),nt=r("span"),He=e(","),_t=g(),E=r("p"),ke=e("This solves the problem but as discussed in "),N=r("a"),Ie=e("Issue #178"),Ce=e(", a better long term solution would be to get more control over the server instance and shut it down when appropriate from the test code."),this.h()},l(l){v=n(l,"P",{});var p=o(v);j=n(p,"A",{href:!0,rel:!0});var Me=o(j);Pt=s(Me,"Chai-http"),Me.forEach(a),jt=s(p," makes it very easy to test Node.js HTTP applications without having to to go through the hassle of finding a free port and start the service manually. By simply passing the server function to the "),ot=n(p,"CODE",{});var Ve=o(ot);wt=s(Ve,"request"),Ve.forEach(a),At=s(p," call it will take care of that for you."),p.forEach(a),ht=P(l),w=n(l,"DIV",{class:!0});var Oe=o(w);S=n(Oe,"DIV",{class:!0});var Be=o(S);b=n(Be,"PRE",{class:!0});var Re=o(b);i=n(Re,"CODE",{});var h=o(i);T=n(h,"SPAN",{class:!0});var Ue=o(T);yt=s(Ue,"const"),Ue.forEach(a),Nt=s(h," chai = "),x=n(h,"SPAN",{class:!0});var We=o(x);St=s(We,"require"),We.forEach(a),bt=s(h,"("),q=n(h,"SPAN",{class:!0});var Ze=o(q);Tt=s(Ze,"'chai'"),Ze.forEach(a),xt=s(h,`)
`),H=n(h,"SPAN",{class:!0});var ze=o(H);qt=s(ze,"const"),ze.forEach(a),Ht=s(h," chaiHttp = "),k=n(h,"SPAN",{class:!0});var Fe=o(k);kt=s(Fe,"require"),Fe.forEach(a),It=s(h,"("),I=n(h,"SPAN",{class:!0});var Ge=o(I);Ct=s(Ge,"'chai-http'"),Ge.forEach(a),Dt=s(h,`)
`),C=n(h,"SPAN",{class:!0});var Je=o(C);Mt=s(Je,"const"),Je.forEach(a),Vt=s(h," express = "),D=n(h,"SPAN",{class:!0});var Ke=o(D);Ot=s(Ke,"require"),Ke.forEach(a),Bt=s(h,"("),M=n(h,"SPAN",{class:!0});var Le=o(M);Rt=s(Le,"'express'"),Le.forEach(a),Ut=s(h,`)

chai.`),V=n(h,"SPAN",{class:!0});var Qe=o(V);Wt=s(Qe,"use"),Qe.forEach(a),Zt=s(h,`(chaiHttp)

`),O=n(h,"SPAN",{class:!0});var Xe=o(O);zt=s(Xe,"const"),Xe.forEach(a),Ft=s(h," app = "),B=n(h,"SPAN",{class:!0});var Ye=o(B);Gt=s(Ye,"express"),Ye.forEach(a),Jt=s(h,`()
`),R=n(h,"SPAN",{class:!0});var $e=o(R);Kt=s($e,"// configure app with middleware and routes..."),$e.forEach(a),Lt=s(h,`

chai
	.`),U=n(h,"SPAN",{class:!0});var ts=o(U);Qt=s(ts,"request"),ts.forEach(a),Xt=s(h,`(app)
	.`),W=n(h,"SPAN",{class:!0});var es=o(W);Yt=s(es,"get"),es.forEach(a),$t=s(h,"("),Z=n(h,"SPAN",{class:!0});var ss=o(Z);te=s(ss,"'/'"),ss.forEach(a),ee=s(h,`)
	.`),z=n(h,"SPAN",{class:!0});var as=o(z);se=s(as,"end"),as.forEach(a),ae=s(h,"("),F=n(h,"SPAN",{class:!0});var ls=o(F);le=s(ls,"function"),ls.forEach(a),re=s(h," ("),G=n(h,"SPAN",{class:!0});var rs=o(G);ne=s(rs,"error, result"),rs.forEach(a),oe=s(h,`) {
		`),J=n(h,"SPAN",{class:!0});var ns=o(J);ie=s(ns,"// Verify error and result"),ns.forEach(a),he=s(h,`
	})`),h.forEach(a),Re.forEach(a),Be.forEach(a),Oe.forEach(a),ct=P(l),_=n(l,"P",{});var mt=o(_);ce=s(mt,"At first I thought it simulated HTTP requests by generating the request/response objects and passing them to the handler function directly. However it seems Chai-http actually finds a free port, starts the service as normal and uses "),A=n(mt,"A",{href:!0,rel:!0});var os=o(A);pe=s(os,"Superagent"),os.forEach(a),ue=s(mt," to send HTTP requests against it."),mt.forEach(a),pt=P(l),K=n(l,"P",{});var is=o(K);de=s(is,"This lead to an issue when switching to Mocha 4."),is.forEach(a),ut=P(l),L=n(l,"H2",{});var hs=o(L);fe=s(hs,"Mocha 4 changed exit behaviour"),hs.forEach(a),dt=P(l),Q=n(l,"P",{});var cs=o(Q);ve=s(cs,"As I started a new project the other day I ran into a problem where the test runner never finishes and initially thought I had messed up my tests. After some investigation it seemed like Node.js never exits the event loop due to the HTTP server still listening to the socket."),cs.forEach(a),ft=P(l),m=n(l,"P",{});var Et=o(m);_e=s(Et,"It turns out that Mocha 4 changed the default exit behaviour to no longer force shutdown the event loop after all tests ran. Using the "),it=n(Et,"CODE",{});var ps=o(it);me=s(ps,"--exit"),ps.forEach(a),Ee=s(Et," flags brings back the old behaviour which Chai-http is relying on to shutdown the HTTP server it started."),Et.forEach(a),vt=P(l),y=n(l,"DIV",{class:!0});var us=o(y);X=n(us,"DIV",{class:!0});var ds=o(X);Y=n(ds,"PRE",{class:!0});var fs=o(Y);u=n(fs,"CODE",{});var f=o(u);ge=s(f,"  "),$=n(f,"SPAN",{class:!0});var vs=o($);Pe=s(vs,'"scripts"'),vs.forEach(a),tt=n(f,"SPAN",{class:!0});var _s=o(tt);je=s(_s,":"),_s.forEach(a),we=s(f," "),et=n(f,"SPAN",{class:!0});var ms=o(et);Ae=s(ms,"{"),ms.forEach(a),ye=s(f,`
    `),st=n(f,"SPAN",{class:!0});var Es=o(st);Ne=s(Es,'"test"'),Es.forEach(a),at=n(f,"SPAN",{class:!0});var gs=o(at);Se=s(gs,":"),gs.forEach(a),be=s(f," "),lt=n(f,"SPAN",{class:!0});var Ps=o(lt);Te=s(Ps,'"mocha --exit"'),Ps.forEach(a),xe=s(f,`
  `),rt=n(f,"SPAN",{class:!0});var js=o(rt);qe=s(js,"}"),js.forEach(a),nt=n(f,"SPAN",{class:!0});var ws=o(nt);He=s(ws,","),ws.forEach(a),f.forEach(a),fs.forEach(a),ds.forEach(a),us.forEach(a),_t=P(l),E=n(l,"P",{});var gt=o(E);ke=s(gt,"This solves the problem but as discussed in "),N=n(gt,"A",{href:!0,rel:!0});var As=o(N);Ie=s(As,"Issue #178"),As.forEach(a),Ce=s(gt,", a better long term solution would be to get more control over the server instance and shut it down when appropriate from the test code."),gt.forEach(a),this.h()},h(){c(j,"href","http://chaijs.com/plugins/chai-http/"),c(j,"rel","nofollow"),c(T,"class","hljs-keyword"),c(x,"class","hljs-built_in"),c(q,"class","hljs-string"),c(H,"class","hljs-keyword"),c(k,"class","hljs-built_in"),c(I,"class","hljs-string"),c(C,"class","hljs-keyword"),c(D,"class","hljs-built_in"),c(M,"class","hljs-string"),c(V,"class","hljs-title function_"),c(O,"class","hljs-keyword"),c(B,"class","hljs-title function_"),c(R,"class","hljs-comment"),c(U,"class","hljs-title function_"),c(W,"class","hljs-title function_"),c(Z,"class","hljs-string"),c(z,"class","hljs-title function_"),c(F,"class","hljs-keyword"),c(G,"class","hljs-params"),c(J,"class","hljs-comment"),c(b,"class","highlight"),c(S,"class","highlight"),c(w,"class","highlighter-rouge language-javascript"),c(A,"href","https://github.com/visionmedia/superagent"),c(A,"rel","nofollow"),c($,"class","hljs-attr"),c(tt,"class","hljs-punctuation"),c(et,"class","hljs-punctuation"),c(st,"class","hljs-attr"),c(at,"class","hljs-punctuation"),c(lt,"class","hljs-string"),c(rt,"class","hljs-punctuation"),c(nt,"class","hljs-punctuation"),c(Y,"class","highlight"),c(X,"class","highlight"),c(y,"class","highlighter-rouge language-json"),c(N,"href","https://github.com/chaijs/chai-http/issues/178"),c(N,"rel","nofollow")},m(l,p){d(l,v,p),t(v,j),t(j,Pt),t(v,jt),t(v,ot),t(ot,wt),t(v,At),d(l,ht,p),d(l,w,p),t(w,S),t(S,b),t(b,i),t(i,T),t(T,yt),t(i,Nt),t(i,x),t(x,St),t(i,bt),t(i,q),t(q,Tt),t(i,xt),t(i,H),t(H,qt),t(i,Ht),t(i,k),t(k,kt),t(i,It),t(i,I),t(I,Ct),t(i,Dt),t(i,C),t(C,Mt),t(i,Vt),t(i,D),t(D,Ot),t(i,Bt),t(i,M),t(M,Rt),t(i,Ut),t(i,V),t(V,Wt),t(i,Zt),t(i,O),t(O,zt),t(i,Ft),t(i,B),t(B,Gt),t(i,Jt),t(i,R),t(R,Kt),t(i,Lt),t(i,U),t(U,Qt),t(i,Xt),t(i,W),t(W,Yt),t(i,$t),t(i,Z),t(Z,te),t(i,ee),t(i,z),t(z,se),t(i,ae),t(i,F),t(F,le),t(i,re),t(i,G),t(G,ne),t(i,oe),t(i,J),t(J,ie),t(i,he),d(l,ct,p),d(l,_,p),t(_,ce),t(_,A),t(A,pe),t(_,ue),d(l,pt,p),d(l,K,p),t(K,de),d(l,ut,p),d(l,L,p),t(L,fe),d(l,dt,p),d(l,Q,p),t(Q,ve),d(l,ft,p),d(l,m,p),t(m,_e),t(m,it),t(it,me),t(m,Ee),d(l,vt,p),d(l,y,p),t(y,X),t(X,Y),t(Y,u),t(u,ge),t(u,$),t($,Pe),t(u,tt),t(tt,je),t(u,we),t(u,et),t(et,Ae),t(u,ye),t(u,st),t(st,Ne),t(u,at),t(at,Se),t(u,be),t(u,lt),t(lt,Te),t(u,xe),t(u,rt),t(rt,qe),t(u,nt),t(nt,He),d(l,_t,p),d(l,E,p),t(E,ke),t(E,N),t(N,Ie),t(E,Ce)},p:De,i:De,o:De,d(l){l&&a(v),l&&a(ht),l&&a(w),l&&a(ct),l&&a(_),l&&a(pt),l&&a(K),l&&a(ut),l&&a(L),l&&a(dt),l&&a(Q),l&&a(ft),l&&a(m),l&&a(vt),l&&a(y),l&&a(_t),l&&a(E)}}}const qs={comments:!0,date:"2017-10-28T00:00:00Z",excerpt:"With Mocha 4, tests using Chai-http will cause the test run to never exit.",section:"blog",tags:["javascript","testing"],title:"Testing with chai-http and Mocha 4"};class Hs extends Ns{constructor(v){super(),Ss(this,v,null,Ts,bs,{})}}export{Hs as default,qs as metadata};
