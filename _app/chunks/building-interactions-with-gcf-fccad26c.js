import{S as Me,i as Ie,s as Ae,w as Ce,f as Ge,m as $e,j as Pe,k as He,q as qe,n as Ee,o as Oe,P as Le,e as l,g as a,a as f,b as t,d as n}from"./vendor-952ab843.js";import{B as We}from"./blog-layout-d30acb2f.js";function Be(h){let i,c,r,u,o,p,d,Y,_,Z,T,J,x,K,S,Q,C,X,F,ee,m,se,H,te,L,ne,v,le,M,ae,j,ie,I,oe,b,pe,A,ce,G,re,$,fe,y,ue,P,de,k,he,q,me,E,ve,w,je,O,be,W,ye,B,ke,g,we,N,ge,U,_e,D,Te,V,xe,z,Se,R;return{c(){i=l("h2"),i.textContent="Google Cloud Functions (GCF)",c=a(),r=l("p"),r.innerHTML="GCF is Googles version of AWS Lambda which provides a <em>\u201Cserver less\u201D</em> (in the sense that as a developer you don\u2019t need to care about anything other than your code) service to run code in the cloud. This type of service is often called Function as a Service, or FaaS for short.",u=a(),o=l("p"),o.textContent="It\u2019s a perfect solution for event triggered small integrations or transformations. Such as a webhook for callbacks from various services. As a developer you only have to implement the event handler and can ignore any OS or HTTP Server setup or administration. The cloud provider takes care of all of that as well as scaling if load increases.",p=a(),d=l("p"),d.innerHTML=`This of course comes with some constraints and in the case of Google Cloud Functions it means a function can be triggered by <em>HTTPS requests</em>, <em>Cloud Storage Events</em> or <em>Pub/Sub</em> and is (currently) limited
to Node.js v6.11.1.`,Y=a(),_=l("h2"),_.textContent="The Catfinder function",Z=a(),T=l("p"),T.textContent="As an example of setting up an integration as a function this post will use a small function that integrates Google Cloud Storage, Google Vision and Slack. It works by getting a change event from a Cloud Storage bucket and send any new files to the Vision API to decide whether it\u2019s an image of a cat. If it is, it will send a message to Slack notifying that a new cat picture was uploaded.",J=a(),x=l("p"),x.innerHTML='All the code for the project can be found at <a href="https://github.com/hallski/cat-finder" rel="nofollow">Github</a>.',K=a(),S=l("h3"),S.textContent="Implementation",Q=a(),C=l("p"),C.innerHTML="A cloud function is a normal NPM module where the script pointed to by <code>main</code> in <code>package.json</code> needs to export a function with the same name as the function (by default, this can be overridden with the <code>--entry-point</code> flag when deploying).",X=a(),F=l("p"),F.innerHTML="In our <code>package.json</code> the main module is defined to be <code>src/index.js</code> and the exported function is called <code>catFinder</code>. The function has different signatures depending on the trigger mechanism. In the case of a bucket event it will have the signature:",ee=a(),m=l("div"),m.innerHTML='<div class="highlight"><pre class="highlight"><code><span class="hljs-built_in">exports</span>.<span class="hljs-property">catFinder</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event, callback</span>) {}</code></pre></div>',se=a(),H=l("p"),H.innerHTML="The <code>event</code> contains information about the event, such as file name, bucket name, event type etc. The <code>callback</code> is used to notify that the function has finished.",te=a(),L=l("p"),L.textContent="The first thing we need to do is check that we care about the event, for this project only newly created files are interesting. In order to keep this logic out of the actual function implementation I\u2019ve written a small helper that wraps the function and returns if the event doesn\u2019t match the criteria.",ne=a(),v=l("div"),v.innerHTML=`<div class="highlight"><pre class="highlight"><code><span class="hljs-comment">// From src/google-cloud.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">filteredEventHandler</span>(<span class="hljs-params">predicate, handler</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">predicate</span>(event)) {
      <span class="hljs-title function_">handler</span>(event, callback)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">callback</span>()
    }
  }
}

<span class="hljs-comment">// In index.js</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">catFinder</span> = <span class="hljs-title function_">filteredEventHandler</span>(storageNewFileEventFilter, <span class="hljs-keyword">function</span>(<span class="hljs-params">event, callback</span>) {
  <span class="hljs-comment">// ...</span>
}</code></pre></div>`,le=a(),M=l("p"),M.innerHTML="The <code>storageNewFileEventFilter</code> function takes in the event and checks whether it\u2019s referring to a new file event. It checks that the resource still exists (otherwise it\u2019s a delete event) and that the <code>metageneration</code> is <code>1</code>, otherwise it\u2019s an update event.",ae=a(),j=l("div"),j.innerHTML=`<div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">storageNewFileEventFilter</span>(<span class="hljs-params">event</span>) {
	<span class="hljs-keyword">const</span> file = event.<span class="hljs-property">data</span>
	<span class="hljs-keyword">return</span> file.<span class="hljs-property">resourceState</span> === <span class="hljs-string">&#39;exists&#39;</span> &amp;&amp; file.<span class="hljs-property">metageneration</span> === <span class="hljs-string">&#39;1&#39;</span>
}</code></pre></div>`,ie=a(),I=l("p"),I.innerHTML="With the help of <em>Promises</em> the rest of the event handler function is very straight forward.",oe=a(),b=l("div"),b.innerHTML='<div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">const</span> file = event.<span class="hljs-property">data</span>\n<span class="hljs-keyword">const</span> storageUri = <span class="hljs-string">`gs://<span class="hljs-subst">${file.bucket}</span>/<span class="hljs-subst">${file.name}</span>`</span>\n\n<span class="hljs-keyword">return</span> <span class="hljs-title function_">visionFetchLabels</span>(storageUri)\n	.<span class="hljs-title function_">then</span>(<span class="hljs-title function_">any</span>(isCat))\n	.<span class="hljs-title function_">then</span>(<span class="hljs-title function_">notifySlack</span>(secrets.<span class="hljs-property">slackWebhook</span>, <span class="hljs-string">`A cat was posted: <span class="hljs-subst">${storageUri}</span>`</span>))\n	.<span class="hljs-title function_">then</span>(logSuccess, logError)\n	.<span class="hljs-title function_">then</span>(callback)</code></pre></div>',pe=a(),A=l("ol"),A.innerHTML=`<li>Fetch the labels through Vision API</li> 
<li>If any of the labels match a cat</li> 
<li>Send a notification to the Slack through an incoming webhook</li> 
<li>If all succeeded, log that. Otherwise log if there was an error.</li> 
<li>Finally, call the provided callback.</li>`,ce=a(),G=l("p"),G.innerHTML="We\u2019ll focus on the <code>visionFetchLabels</code>, <code>isCat</code> and <code>notifySlack</code> functions in this post and talk more about using promises like this in a separate post.",re=a(),$=l("p"),$.innerHTML="Using the <em>Vision</em> API to fetch labels from an image in Cloud Storage is as easy as:",fe=a(),y=l("div"),y.innerHTML=`<div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">visionFetchLabels</span>(<span class="hljs-params">uri</span>) {
	<span class="hljs-keyword">const</span> visionRequest = { <span class="hljs-attr">source</span>: { <span class="hljs-attr">imageUri</span>: uri } }

	<span class="hljs-keyword">return</span> vision.<span class="hljs-title function_">labelDetection</span>(visionRequest).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">results</span>) {
		<span class="hljs-keyword">return</span> results[<span class="hljs-number">0</span>].<span class="hljs-property">labelAnnotations</span>
	})
}</code></pre></div>`,ue=a(),P=l("p"),P.innerHTML="The function returns a promise that fulfills to an array of label objects. The label objects contains a description and a score of how likely it is that the description matches the image. This information is used in <code>isCat</code> to determine if the image actually portraits a cat.",de=a(),k=l("div"),k.innerHTML=`<div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">isCat</span>(<span class="hljs-params">label</span>) {
	<span class="hljs-keyword">return</span> label.<span class="hljs-property">description</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#39;cat&#39;</span>) !== -<span class="hljs-number">1</span> &amp;&amp; label.<span class="hljs-property">score</span> &gt; <span class="hljs-number">0.8</span>
}</code></pre></div>`,he=a(),q=l("p"),q.innerHTML="This is a pretty naive implementation which simply checks if any of the label descriptions contain the word cat and whether the score is above <code>0.8</code> (from 0-1.0).",me=a(),E=l("p"),E.textContent="Finally, if the image is determined to match a cat, it\u2019s posted to Slack through a webhook, which is also very straight forward:",ve=a(),w=l("div"),w.innerHTML=`<div class="highlight"><pre class="highlight"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">notifySlack</span>(<span class="hljs-params">webhook, message</span>) {
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
		<span class="hljs-keyword">return</span> request.<span class="hljs-title function_">post</span>(webhook).<span class="hljs-title function_">send</span>({ <span class="hljs-attr">text</span>: message })
	}
}</code></pre></div>`,je=a(),O=l("p"),O.textContent="The webhook is provided by Slack through creating a new App and adding an Incoming Webhook.",be=a(),W=l("h3"),W.textContent="Deploying the function",ye=a(),B=l("p"),B.textContent="The function is deployed to the cloud through the following command:",ke=a(),g=l("div"),g.innerHTML='<div class="highlight"><pre class="highlight"><code>$ gcloud beta <span class="hljs-built_in">functions</span> deploy --memory 128 catFinder --stage-bucket function-deploy-stage --trigger-bucket=catfinder-image-bucket</code></pre></div>',we=a(),N=l("p"),N.innerHTML="The trigger type is specified to be a bucket (meaning in storage event) and the bucket ID is <code>image-bucket-1</code>. When deploying a function this way the current directory is zipped up and pushed to the <code>stage-bucket</code> which is then used to deploy the function in the cloud.",ge=a(),U=l("p"),U.innerHTML="In the source root directory there is a small script called <code>deploy.sh</code> that creates a DEPLOY directory and copies the correct files to it and runs the above command.",_e=a(),D=l("h2"),D.textContent="Summary",Te=a(),V=l("p"),V.textContent="Cloud functions can be a great way to quickly setup some data transformation as a reaction on new files being uploaded. Or it can act as the backend for a callback from for example Slack, Github etc.",xe=a(),z=l("p"),z.textContent="As demonstrated the deployment didn\u2019t require any setup other than creating a Slack app to retrieve an incoming webhook and writing the event handler that is triggered by changes to a Storage bucket. If a lot of events are coming from the bucket, the Cloud Function service will automatically make sure that more handlers are executed to handle the incoming load.",Se=a(),R=l("p"),R.textContent="Hopefully this post showed some of the power of using FaaS solutions to react to events and create an integration between different services.",f(m,"class","highlighter-rouge language-javascript"),f(v,"class","highlighter-rouge language-javascript"),f(j,"class","highlighter-rouge language-javascript"),f(b,"class","highlighter-rouge language-javascript"),f(y,"class","highlighter-rouge language-javascript"),f(k,"class","highlighter-rouge language-javascript"),f(w,"class","highlighter-rouge language-javascript"),f(g,"class","highlighter-rouge language-bash")},m(e,s){t(e,i,s),t(e,c,s),t(e,r,s),t(e,u,s),t(e,o,s),t(e,p,s),t(e,d,s),t(e,Y,s),t(e,_,s),t(e,Z,s),t(e,T,s),t(e,J,s),t(e,x,s),t(e,K,s),t(e,S,s),t(e,Q,s),t(e,C,s),t(e,X,s),t(e,F,s),t(e,ee,s),t(e,m,s),t(e,se,s),t(e,H,s),t(e,te,s),t(e,L,s),t(e,ne,s),t(e,v,s),t(e,le,s),t(e,M,s),t(e,ae,s),t(e,j,s),t(e,ie,s),t(e,I,s),t(e,oe,s),t(e,b,s),t(e,pe,s),t(e,A,s),t(e,ce,s),t(e,G,s),t(e,re,s),t(e,$,s),t(e,fe,s),t(e,y,s),t(e,ue,s),t(e,P,s),t(e,de,s),t(e,k,s),t(e,he,s),t(e,q,s),t(e,me,s),t(e,E,s),t(e,ve,s),t(e,w,s),t(e,je,s),t(e,O,s),t(e,be,s),t(e,W,s),t(e,ye,s),t(e,B,s),t(e,ke,s),t(e,g,s),t(e,we,s),t(e,N,s),t(e,ge,s),t(e,U,s),t(e,_e,s),t(e,D,s),t(e,Te,s),t(e,V,s),t(e,xe,s),t(e,z,s),t(e,Se,s),t(e,R,s)},d(e){e&&n(i),e&&n(c),e&&n(r),e&&n(u),e&&n(o),e&&n(p),e&&n(d),e&&n(Y),e&&n(_),e&&n(Z),e&&n(T),e&&n(J),e&&n(x),e&&n(K),e&&n(S),e&&n(Q),e&&n(C),e&&n(X),e&&n(F),e&&n(ee),e&&n(m),e&&n(se),e&&n(H),e&&n(te),e&&n(L),e&&n(ne),e&&n(v),e&&n(le),e&&n(M),e&&n(ae),e&&n(j),e&&n(ie),e&&n(I),e&&n(oe),e&&n(b),e&&n(pe),e&&n(A),e&&n(ce),e&&n(G),e&&n(re),e&&n($),e&&n(fe),e&&n(y),e&&n(ue),e&&n(P),e&&n(de),e&&n(k),e&&n(he),e&&n(q),e&&n(me),e&&n(E),e&&n(ve),e&&n(w),e&&n(je),e&&n(O),e&&n(be),e&&n(W),e&&n(ye),e&&n(B),e&&n(ke),e&&n(g),e&&n(we),e&&n(N),e&&n(ge),e&&n(U),e&&n(_e),e&&n(D),e&&n(Te),e&&n(V),e&&n(xe),e&&n(z),e&&n(Se),e&&n(R)}}}function Ne(h){let i,c;const r=[h[0],Fe];let u={$$slots:{default:[Be]},$$scope:{ctx:h}};for(let o=0;o<r.length;o+=1)u=Ce(u,r[o]);return i=new We({props:u}),{c(){Ge(i.$$.fragment)},m(o,p){$e(i,o,p),c=!0},p(o,[p]){const d=p&1?Pe(r,[p&1&&He(o[0]),p&0&&He(Fe)]):{};p&2&&(d.$$scope={dirty:p,ctx:o}),i.$set(d)},i(o){c||(qe(i.$$.fragment,o),c=!0)},o(o){Ee(i.$$.fragment,o),c=!1},d(o){Oe(i,o)}}}const Fe={comments:!0,date:"2017-11-03T00:00:00Z",excerpt:"Google Cloud Functions are currently in beta but can already provide a great solution for integrating between different services triggered by various events.",redirect_from:"/blog/fun-with-gcf-vision-and-slack",section:"blog",tags:["javascript","google-cloud","FaaS"],title:"Building integrations with Google Cloud Functions"};function Ue(h,i,c){return h.$$set=r=>{c(0,i=Ce(Ce({},i),Le(r)))},i=Le(i),[i]}class De extends Me{constructor(i){super();Ie(this,i,Ue,Ne,Ae,{})}}var Re=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:De,metadata:Fe});export{De as B,Re as _,Fe as m};
